<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Guard • Grand Est</title>
    
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Barlow:wght@500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="data.js"></script>

    <style>
        /* --- CHARTE BLEUE (DESIGN FIGÉ) --- */
        :root {
            --brand-primary: #004578; 
            --brand-light: #0078d4;
            --brand-accent: #00bcf2;
            
            --bg-app: #f3f2f1;
            --text-dark: #201f1e;
            --text-gray: #605e5c;
            --surface: #ffffff;
            --border: #e1dfdd;
            --acc-header: #f3f2f1;
            
            --font-head: 'Barlow', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        body { margin: 0; font-family: var(--font-body); background: var(--bg-app); color: var(--text-dark); overflow: hidden; }
        
        .page { position: absolute; inset: 0; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s; z-index: 10; background: var(--bg-app); }
        .page.hidden { transform: translateY(-100vh); opacity: 0; pointer-events: none; z-index: 0; }

        /* --- LANDING --- */
        #landing { display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(160deg, var(--brand-primary) 0%, #002050 100%); color: white; padding: 20px; }
        .landing-container { max-width: 900px; width: 100%; text-align: center; }
        .brand-logo { width: 80px; height: 80px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 16px; font-size: 2.5rem; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px; color: var(--brand-accent); }
        h1.portal-title { font-family: var(--font-head); font-size: 3.5rem; margin: 0; letter-spacing: -1px; font-weight: 800; }
        p.portal-subtitle { font-size: 1.2rem; opacity: 0.8; margin-top: 10px; font-weight: 300; max-width: 600px; margin-left: auto; margin-right: auto; }
        .btn-enter { background: var(--brand-accent); color: #002050; border: none; padding: 18px 40px; border-radius: 4px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 40px; margin-bottom: 60px; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-enter:hover { background: white; transform: scale(1.05); }
        .features-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; }
        .feature-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 25px; border-radius: 8px; backdrop-filter: blur(5px); transition: transform 0.3s; }
        .feature-card:hover { background: rgba(255,255,255,0.1); }
        .feature-card h3 { margin: 0 0 10px; font-family: var(--font-head); color: var(--brand-accent); font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .feature-card p { margin: 0; font-size: 0.9rem; line-height: 1.6; opacity: 0.8; }

        /* --- APP --- */
        #app { display: flex; height: 100vh; width: 100vw; }
        #map { flex: 1; height: 100%; }
        .sidebar { position: absolute; top: 0; left: 0; bottom: 0; width: 400px; background: var(--surface); z-index: 20; display: flex; flex-direction: column; box-shadow: 5px 0 15px rgba(0,0,0,0.05); border-right: 1px solid var(--border); }
        .sb-header { padding: 25px; background: var(--brand-primary); color: white; display: flex; align-items: center; justify-content: space-between; }
        .sb-title h2 { margin: 0; font-family: var(--font-head); font-size: 1.4rem; font-weight: 700; }
        .sb-title span { font-size: 0.75rem; opacity: 0.7; letter-spacing: 0.5px; text-transform: uppercase; }
        .btn-home { background: rgba(255,255,255,0.1); border:none; color:white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-home:hover { background: var(--brand-accent); color: var(--brand-primary); }
        .sb-scroll { flex: 1; overflow-y: auto; padding: 25px; position: relative; }

        /* KPI */
        .kpi-row { display: flex; gap: 15px; margin-bottom: 25px; position: relative; z-index: 5; }
        .kpi-box { flex: 1; border-left: 4px solid var(--brand-accent); padding-left: 15px; }
        .kpi-val { display: block; font-family: var(--font-head); font-weight: 700; font-size: 2rem; color: var(--text-dark); line-height: 1; }
        .kpi-lbl { font-size: 0.75rem; color: var(--text-gray); font-weight: 600; text-transform: uppercase; margin-top: 5px; display: flex; align-items: center; gap: 6px;}

        /* TOOLTIP */
        .info-icon { cursor: pointer; color: var(--brand-light); position: relative; }
        .info-icon:hover .tooltip-box { visibility: visible; opacity: 1; transform: translateY(0); }
        .tooltip-box { visibility: hidden; opacity: 0; position: absolute; top: 25px; right: -10px; width: 220px; background-color: #002050; color: #fff; text-transform: none; text-align: center; padding: 12px; border-radius: 6px; font-size: 0.75rem; line-height: 1.4; font-weight: 400; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.2s ease; transform: translateY(-5px); z-index: 9999; pointer-events: none; }
        .tooltip-box::after { content: ""; position: absolute; bottom: 100%; right: 14px; border-width: 6px; border-style: solid; border-color: transparent transparent #002050 transparent; }

        /* SELECTEUR */
        .select-commune { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: #f8f9fa; color: var(--text-dark); font-family: var(--font-body); font-size: 0.85rem; font-weight: 500; cursor: pointer; outline: none; }
        .select-commune:focus { border-color: var(--brand-primary); }
        .select-loader { font-size: 0.7rem; color: var(--brand-light); margin-top: 5px; font-style: italic; display: none; }

        /* FILTRES */
        .filter-section { margin-bottom: 25px; padding: 15px; background: white; border: 1px solid var(--border); border-radius: 8px; }
        .filter-header { font-size: 0.75rem; font-weight: 700; color: var(--brand-primary); margin-bottom: 10px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .tags-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 6px 12px; border-radius: 4px; cursor: pointer; background: #eff6fc; color: var(--text-gray); font-weight: 600; border: 1px solid transparent; transition: all 0.2s; }
        .tag:hover { opacity: 0.8; }
        .tag.active { color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-color: transparent; }

        /* GRAPHIQUES */
        .viz-block { background: white; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        .viz-header { background: #f8f9fa; padding: 10px 15px; font-weight: 600; font-size: 0.85rem; color: var(--brand-primary); border-bottom: 1px solid var(--border); }
        .viz-body { padding: 15px; }

        details.info-box { width: 100%; margin-bottom: 20px; }
        details.info-box summary { background-color: var(--acc-header); color: var(--text-gray); padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        details.info-box summary::-webkit-details-marker { display: none; }
        details.info-box summary::after { content: '+'; font-weight: 800; font-size: 1rem; }
        details.info-box[open] summary::after { content: '-'; }
        details.info-box .info-content { padding: 12px; background: white; border: 1px solid var(--border); border-top: none; font-size: 0.75rem; color: var(--text-gray); line-height: 1.5; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }

        /* CONTROLES */
        .layer-control { margin-top:auto; display:flex; flex-direction:column; gap:8px; }
        .layer-btn { padding:12px 15px; background:#e1dfdd; border-radius:4px; cursor:pointer; font-weight:600; font-size:0.85rem; display:flex; align-items:center; gap:10px; color:#201f1e; transition: background 0.2s; border: 1px solid transparent; }
        .layer-btn:hover { background: #d0d0d0; }
        .layer-btn.active { background: white; border-color: var(--brand-primary); color: var(--brand-primary); }

        /* POPUP */
        .maplibregl-popup-content { padding: 0; border-radius: 4px; overflow: hidden; border: 1px solid var(--brand-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .pop-head { background: var(--brand-primary); color: white; padding: 8px 12px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .pop-body { padding: 12px; font-size: 0.9rem; font-weight: 600; color: var(--text-dark); }
    </style>
</head>
<body>

    <div id="landing" class="page">
        <div class="landing-container">
            <div class="brand-logo"><i class="fa-solid fa-layer-group"></i></div>
            <h1 class="portal-title">FOREST GUARD</h1>
            <p class="portal-subtitle">Plateforme régionale de visualisation des risques incendie et d'analyse de la vulnérabilité forestière.</p>
            <button class="btn-enter" onclick="enterApp()">Explorer les données <i class="fa-solid fa-arrow-right" style="margin-left:8px"></i></button>
            <div class="features-grid">
                <div class="feature-card"><h3><i class="fa-solid fa-database"></i> Source & Méthodologie</h3><p>Données issues du référentiel régional 2025. L'indice IVM est calculé par croisement des données IGN (végétation) et météo (hygrométrie).</p></div>
                <div class="feature-card"><h3><i class="fa-solid fa-cube"></i> Visualisation 3D Inversée</h3><p>Pour une meilleure lisibilité, l'axe Z est inversé : les zones <strong>Critiques (Rouges)</strong> sont au sol (niveau 0), tandis que les zones sûres sont surélevées.</p></div>
            </div>
        </div>
    </div>

    <div id="app" class="page hidden">
        <aside class="sidebar">
            <div class="sb-header">
                <div class="sb-title"><h2>Forest Guard</h2><span>Région Grand Est • 68</span></div>
                <button class="btn-home" onclick="goHome()" title="Retour Accueil"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="sb-scroll">
                
                <div class="viz-block" style="border:none; box-shadow:none; background:transparent;">
                    <div class="viz-header" style="background:transparent; padding-left:0; border:none; margin-bottom:5px;">
                        <i class="fa-solid fa-city"></i> CHOIX DU TERRITOIRE
                    </div>
                    <select id="commune-select" class="select-commune" onchange="changeCommune(this.value)" disabled>
                        <option value="">Chargement des communes...</option>
                    </select>
                    <div id="loading-msg" class="select-loader"><i class="fa-solid fa-circle-notch fa-spin"></i> Calcul des appartenances géographiques...</div>
                </div>

                <div class="kpi-row">
                    <div class="kpi-box">
                        <span class="kpi-val" id="val-surf">--</span>
                        <span class="kpi-lbl">Surface (Ha)</span>
                    </div>
                    <div class="kpi-box">
                        <span class="kpi-val" id="val-ivm">--</span>
                        <div class="kpi-lbl">Indice Moyen / 4 <span class="info-icon"><i class="fa-solid fa-circle-info" style="margin-left:5px;"></i><div class="tooltip-box"><strong>Indice de Vulnérabilité (IVM)</strong><br>Calculé de 0 (Nul) à 4 (Critique) selon la densité de combustible et la sécheresse des sols.</div></span></div>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-header"><i class="fa-solid fa-filter"></i> FILTRER PAR RISQUE</div>
                    <div class="tags-group" id="filter-container"></div>
                </div>

                <div class="viz-block">
                    <div class="viz-header"><span><i class="fa-solid fa-chart-pie"></i> VULNÉRABILITÉ GLOBALE</span></div>
                    <div class="viz-body" style="height: 200px;"><canvas id="polarChart"></canvas></div>
                </div>
                <details class="info-box"><summary>Comprendre ce graphique</summary><div class="info-content">Ce radar montre la distribution des surfaces. Une forme étirée vers une couleur indique une prédominance de ce niveau de risque.</div></details>

                <div class="viz-block">
                    <div class="viz-header"><span><i class="fa-solid fa-chart-column"></i> DÉTAIL PAR NIVEAU</span></div>
                    <div class="viz-body" style="height: 160px;"><canvas id="barChart"></canvas></div>
                </div>
                <details class="info-box"><summary>Détail des données</summary><div class="info-content">Répartition en pourcentage de la surface totale visible. Permet d'identifier rapidement la proportion de zones critiques.</div></details>

                <div class="layer-control">
                    <div class="layer-btn" onclick="toggleLayer('sat')" id="btn-sat"><i class="fa-solid fa-earth-europe"></i> Vue Satellite</div>
                    <div class="layer-btn" onclick="toggleLayer('com')" id="btn-com"><i class="fa-solid fa-vector-square"></i> Limites Communales</div>
                </div>
            </div>
        </aside>

        <div id="map"></div>
    </div>

    <script>
        // === CONFIG ===
        const config = {
            riskColors: ['#10b981', '#34d399', '#facc15', '#fb923c', '#ef4444'], 
            labels: ['Nul', 'Faible', 'Moyen', 'Fort', 'Critique']
        };

        // Etats
        let activeRiskFilters = [0, 1, 2, 3, 4];
        let selectedCommune = null;
        let polarChart = null;
        let barChart = null;
        // Contiendra les communes GeoJSON
        let communesFeatureCollection = null; 

        // --- NAVIGATION ---
        function enterApp() {
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            setTimeout(() => map.resize(), 600);
        }
        function goHome() {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('landing').classList.remove('hidden');
        }

        // --- ALGORITHME POINT DANS POLYGONE (RAY CASTING) ---
        // Permet de trouver la commune sans bibliothèque externe lourde
        function isPointInPolygon(point, vs) {
            var x = point[0], y = point[1];
            var inside = false;
            for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                var xi = vs[i][0], yi = vs[i][1];
                var xj = vs[j][0], yj = vs[j][1];
                var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // --- INIT MAP ---
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
            center: [7.35, 47.9], zoom: 9.5, pitch: 50, bearing: -10, antialias: true
        });

        map.on('load', async () => {
            if (typeof forestData === 'undefined') { console.error("Data missing"); return; }

            // 1. Charger les contours des communes (API Gouv)
            document.getElementById('loading-msg').style.display = 'block';
            
            try {
                const response = await fetch('https://geo.api.gouv.fr/departements/68/communes?geometry=contour&format=geojson');
                communesFeatureCollection = await response.json();
                
                // 2. JOINTURE SPATIALE (CALCUL MATHEMATHIQUE)
                // Pour chaque forêt, on trouve son centre et on cherche dans quelle commune il tombe
                forestData.features.forEach(forest => {
                    // On prend le premier point du polygone comme référence (simple et rapide)
                    let p = forest.geometry.type === 'Polygon' ? forest.geometry.coordinates[0][0] : forest.geometry.coordinates[0][0][0];
                    
                    // On cherche la commune correspondante
                    let foundCommune = communesFeatureCollection.features.find(com => {
                        // Gestion MultiPolygon vs Polygon pour les communes
                        if(com.geometry.type === 'Polygon') {
                            return isPointInPolygon(p, com.geometry.coordinates[0]);
                        } else {
                            // Pour MultiPolygon, on teste chaque polygone
                            return com.geometry.coordinates.some(poly => isPointInPolygon(p, poly[0]));
                        }
                    });

                    // On assigne le nom trouvé aux propriétés de la forêt
                    if(foundCommune) {
                        forest.properties.NOM_CALCULE = foundCommune.properties.nom;
                    } else {
                        forest.properties.NOM_CALCULE = "Inconnu";
                    }
                });

                // 3. Remplir le selecteur avec les noms trouvés
                const uniqueCommunes = [...new Set(forestData.features.map(f => f.properties.NOM_CALCULE))].sort();
                const select = document.getElementById('commune-select');
                select.innerHTML = '<option value="">Tout le département</option>';
                uniqueCommunes.forEach(nom => {
                    if(nom !== "Inconnu") {
                        const opt = document.createElement('option');
                        opt.value = nom; opt.innerText = nom;
                        select.appendChild(opt);
                    }
                });
                select.disabled = false;
                document.getElementById('loading-msg').style.display = 'none';

                // 4. Ajouter la couche COMMUNES (cachée par défaut)
                map.addSource('com', { type: 'geojson', data: communesFeatureCollection });
                map.addLayer({ 
                    id: 'com', type: 'line', source: 'com', 
                    paint: { 'line-color': '#1e293b', 'line-width': 2, 'line-opacity': 0 },
                    layout: { 'visibility': 'none' } 
                });

            } catch (e) {
                console.error("Erreur chargement communes", e);
                document.getElementById('loading-msg').innerText = "Erreur chargement données géo.";
            }

            // 5. Ajouter les autres couches
            map.addSource('sat', { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 });
            map.addLayer({ id: 'sat', type: 'raster', source: 'sat', paint: { 'raster-opacity': 0 } });

            map.addSource('foret', { type: 'geojson', data: forestData });
            map.addLayer({
                id: 'foret-3d', type: 'fill-extrusion', source: 'foret',
                paint: {
                    'fill-extrusion-color': ['interpolate', ['linear'], ['get', 'DN'], 0, config.riskColors[0], 1, config.riskColors[1], 2, config.riskColors[2], 3, config.riskColors[3], 4, config.riskColors[4]],
                    'fill-extrusion-height': ['interpolate', ['linear'], ['get', 'DN'], 0, 3000, 4, 50],
                    'fill-extrusion-opacity': 0.9,
                    'fill-extrusion-vertical-gradient': true
                }
            });

            // Zoom Initial
            zoomToAll();

            // Popup
            const popup = new maplibregl.Popup({closeButton:false, closeOnClick:false});
            map.on('mousemove', 'foret-3d', (e)=>{
                map.getCanvas().style.cursor = 'pointer';
                const p = e.features[0].properties;
                popup.setLngLat(e.lngLat).setHTML(`
                    <div class="pop-head" style="background:${config.riskColors[p.DN]}">RISQUE ${config.labels[p.DN]}</div>
                    <div class="pop-body">
                        <div>${Math.round(p.surf/10000).toLocaleString()} Ha</div>
                        <div style="font-size:0.7rem; color:#666; margin-top:4px;">${p.NOM_CALCULE || 'Zone forestière'}</div>
                    </div>
                `).addTo(map);
            });
            map.on('mouseleave', 'foret-3d', ()=>{ map.getCanvas().style.cursor=''; popup.remove(); });

            updateInterface();
            initFilters();
        });

        // --- LOGIQUE FILTRE & UPDATE ---

        window.changeCommune = function(nom) {
            selectedCommune = nom === "" ? null : nom;
            
            // Zoom sur la commune
            if(selectedCommune && communesFeatureCollection) {
                const comFeature = communesFeatureCollection.features.find(f => f.properties.nom === selectedCommune);
                if(comFeature) {
                    const b = new maplibregl.LngLatBounds();
                    // On gère simple polygon ou multipolygon pour le bound
                    const coords = comFeature.geometry.type === 'Polygon' ? comFeature.geometry.coordinates[0] : comFeature.geometry.coordinates.flat(1);
                    coords.forEach(p => b.extend(p));
                    map.fitBounds(b, { padding: 20 });
                }
            } else {
                zoomToAll();
            }

            applyMapFilters();
            updateInterface();
        }

        function zoomToAll() {
            const b = new maplibregl.LngLatBounds();
            forestData.features.forEach(f => {
                const c = f.geometry.type === 'Polygon' ? f.geometry.coordinates[0] : f.geometry.coordinates.flat(1);
                c.forEach(p => b.extend(p));
            });
            if(!b.isEmpty()) map.fitBounds(b, { padding: {top:50, bottom:50, left:420, right:50} });
        }

        function applyMapFilters() {
            const riskFilter = ['in', ['get', 'DN'], ['literal', activeRiskFilters]];
            if (selectedCommune) {
                // Filtre combiné : Risque + Nom Calculé
                map.setFilter('foret-3d', ['all', riskFilter, ['==', ['get', 'NOM_CALCULE'], selectedCommune]]);
            } else {
                map.setFilter('foret-3d', riskFilter);
            }
        }

        function updateInterface() {
            let filteredFeatures = forestData.features;
            if (selectedCommune) {
                filteredFeatures = filteredFeatures.filter(f => f.properties.NOM_CALCULE === selectedCommune);
            }

            let dist = [0,0,0,0,0];
            let totalSurf = 0, sumRisk = 0, highRiskSurf = 0;

            filteredFeatures.forEach(f => {
                const dn = f.properties.DN; 
                const s = f.properties.surf;
                dist[dn] += s;
                totalSurf += s;
                sumRisk += (s * dn);
                if(dn >= 3) highRiskSurf += s;
            });

            document.getElementById('val-surf').innerText = (highRiskSurf/10000).toFixed(0).toLocaleString();
            document.getElementById('val-ivm').innerText = totalSurf > 0 ? (sumRisk/totalSurf).toFixed(2) : "0";

            updateCharts(dist);
        }

        function updateCharts(dataArr) {
            const total = dataArr.reduce((a,b)=>a+b,0);
            const val = total > 0 ? dataArr.map(d => ((d/total)*100).toFixed(1)) : [0,0,0,0,0];
            
            if(polarChart) { polarChart.data.datasets[0].data = val; polarChart.update(); }
            else {
                Chart.defaults.font.family = 'Inter'; Chart.defaults.color = '#605e5c';
                polarChart = new Chart(document.getElementById('polarChart'), {
                    type: 'polarArea',
                    data: { labels: config.labels, datasets:[{ data:val, backgroundColor: config.riskColors.map(c=>c+'CC'), borderWidth:0 }] },
                    options: { responsive:true, maintainAspectRatio:false, scales:{r:{ticks:{display:false}, grid:{color:'#e1dfdd'}}}, plugins:{legend:{display:false}} }
                });
            }

            if(barChart) { barChart.data.datasets[0].data = val; barChart.update(); }
            else {
                barChart = new Chart(document.getElementById('barChart'), {
                    type: 'bar',
                    data: { labels: config.labels, datasets:[{ data:val, backgroundColor:config.riskColors, borderRadius:4 }] },
                    options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{display:false}}} }
                });
            }
        }

        // --- FILTRES COULEURS ---
        function initFilters() {
            const c = document.getElementById('filter-container');
            config.labels.forEach((l, i)=>{
                const t = document.createElement('div');
                t.className = 'tag active'; t.innerText = l;
                t.style.backgroundColor = config.riskColors[i]; // Couleur initiale
                t.onclick = ()=>{
                    const idx = activeRiskFilters.indexOf(i);
                    if(idx>-1) { 
                        if(activeRiskFilters.length>1) { 
                            activeRiskFilters.splice(idx,1); 
                            t.classList.remove('active');
                            t.style.backgroundColor = ''; // Enlever couleur
                        } 
                    } else { 
                        activeRiskFilters.push(i); 
                        t.classList.add('active');
                        t.style.backgroundColor = config.riskColors[i]; // Remettre couleur
                    }
                    applyMapFilters();
                };
                c.appendChild(t);
            });
        }

        window.toggleLayer = function(layerId) {
            const btn = document.getElementById('btn-' + layerId);
            if(layerId === 'sat') {
                const op = map.getPaintProperty('sat','raster-opacity');
                const newVal = op === 1 ? 0 : 1;
                map.setPaintProperty('sat','raster-opacity', newVal);
                if(newVal === 1) btn.classList.add('active'); else btn.classList.remove('active');
            }
            if(layerId === 'com') {
                const vis = map.getLayoutProperty('com', 'visibility');
                const newVal = vis === 'visible' ? 'none' : 'visible';
                map.setLayoutProperty('com', 'visibility', newVal);
                map.setPaintProperty('com', 'line-opacity', newVal === 'visible' ? 0.6 : 0);
                if(newVal === 'visible') btn.classList.add('active'); else btn.classList.remove('active');
            }
        }
    </script>
</body>
</html>