<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Guard Pro • Debug Mode</title>
    
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="data.js"></script>

    <style>
        :root { --primary: #10b981; --bg: #0f172a; --glass: rgba(15, 23, 42, 0.95); --text: #f1f5f9; --font: 'Outfit', sans-serif; }
        body { margin: 0; font-family: var(--font); background: var(--bg); color: var(--text); overflow: hidden; }
        #app { display: flex; height: 100vh; width: 100vw; }
        #map { flex: 1; }

        /* SIDEBAR */
        .sidebar {
            position: absolute; top: 15px; left: 15px; bottom: 15px; width: 380px;
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 20px; z-index: 10;
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto;
        }

        .header { display: flex; align-items: center; gap: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { width: 45px; height: 45px; background: var(--primary); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: #fff; }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }

        .kpi-row { display: flex; gap: 10px; }
        .kpi { flex: 1; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; text-align: center; }
        .kpi strong { display: block; font-size: 1.5rem; color: #fff; }
        .title { font-size: 0.9rem; color: var(--primary); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* --- CORRECTION CRITIQUE : HAUTEUR FORCÉE --- */
        .chart-box {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 10px;
            width: 100%;
            position: relative;
        }
        /* On force la hauteur pour le Polaire */
        #polar-container { height: 250px; min-height: 250px; }
        /* On force la hauteur pour les Barres */
        #bar-container { height: 180px; min-height: 180px; }

        .btn { background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .btn:hover { background: rgba(255,255,255,0.1); }
        .btn.active { background: rgba(16, 185, 129, 0.3); border: 1px solid var(--primary); }
        
        .maplibregl-popup-content { background: #0f172a !important; color: #fff !important; font-family: 'Outfit'; padding: 10px; border: 1px solid #334155; }
    </style>
</head>
<body>

<div id="app">
    <aside class="sidebar">
        <div class="header">
            <div class="logo"><i class="fa-solid fa-tree"></i></div>
            <div>
                <h1>Forest Guard</h1>
                <p style="margin:0; opacity:0.6; font-size:0.8rem;">Analyse Haut-Rhin</p>
            </div>
        </div>

        <div class="kpi-row">
            <div class="kpi">
                <span style="font-size:0.7rem;">Surface (Ha)</span>
                <strong id="val-surf">--</strong>
            </div>
            <div class="kpi">
                <span style="font-size:0.7rem;">Indice IVM</span>
                <strong id="val-ivm">--</strong>
            </div>
        </div>

        <div>
            <div class="title">Vulnérabilité</div>
            <div class="chart-box" id="polar-container">
                <canvas id="polarChart"></canvas>
            </div>
        </div>

        <div>
            <div class="title">Répartition</div>
            <div class="chart-box" id="bar-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div class="title" style="margin-top:10px;">Couches</div>
        <div class="btn" onclick="toggleLayer('sat')"><i class="fa-solid fa-satellite"></i> Satellite</div>
        <div class="btn" onclick="toggleLayer('com')"><i class="fa-solid fa-city"></i> Communes</div>
    </aside>

    <div id="map"></div>
</div>

<script>
    // 1. CONFIG
    const colors = ['#059669', '#34d399', '#facc15', '#fb923c', '#ef4444'];
    
    // 2. MAP
    const map = new maplibregl.Map({
        container: 'map',
        style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        center: [7.35, 47.9], zoom: 9, pitch: 50, antialias: true
    });

    map.on('load', () => {
        // --- COUCHES ---
        map.addSource('sat', { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 });
        map.addLayer({ id: 'sat', type: 'raster', source: 'sat', paint: { 'raster-opacity': 0 } });

        fetch('https://geo.api.gouv.fr/departements/68/communes?geometry=contour&format=geojson&type=commune-actuelle')
            .then(r => r.json()).then(d => {
                map.addSource('com', { type: 'geojson', data: d });
                map.addLayer({ id: 'com', type: 'line', source: 'com', paint: { 'line-color': '#fff', 'line-opacity': 0 }, layout: {'visibility':'none'} });
            });

        // --- DONNEES ---
        if(typeof forestData !== 'undefined') {
            map.addSource('foret', { type: 'geojson', data: forestData });
            map.addLayer({
                id: 'foret-3d', type: 'fill-extrusion', source: 'foret',
                paint: {
                    'fill-extrusion-color': ['interpolate', ['linear'], ['get', 'DN'], 0, colors[0], 4, colors[4]],
                    'fill-extrusion-height': ['interpolate', ['linear'], ['get', 'DN'], 0, 50, 4, 3000],
                    'fill-extrusion-opacity': 0.9
                }
            });
            
            // Zoom
            const b = new maplibregl.LngLatBounds();
            forestData.features.forEach(f => {
               const c = f.geometry.type === 'Polygon' ? f.geometry.coordinates[0] : f.geometry.coordinates.flat(1);
               c.forEach(p => b.extend(p));
            });
            if(!b.isEmpty()) map.fitBounds(b, { padding: 50 });

            // Popup
            const popup = new maplibregl.Popup({closeButton:false, closeOnClick:false});
            map.on('mousemove', 'foret-3d', (e)=>{
                map.getCanvas().style.cursor = 'pointer';
                const p = e.features[0].properties;
                popup.setLngLat(e.lngLat).setHTML(`Niveau ${p.DN}<br>${(p.surf/10000).toFixed(1)} ha`).addTo(map);
            });
            map.on('mouseleave', 'foret-3d', ()=>{ map.getCanvas().style.cursor=''; popup.remove(); });

            // Lancer les calculs
            processData(forestData);
        } else {
            alert("Erreur: data.js manquant");
        }
    });

    // 3. CALCULS ET AFFICHAGE
    function processData(data) {
        let dist = [0,0,0,0,0];
        let total = 0, riskSum = 0, high = 0;

        data.features.forEach(f => {
            const dn = f.properties.DN;
            const surf = f.properties.surf;
            if(dist[dn] !== undefined) dist[dn] += surf;
            total += surf;
            riskSum += (surf * dn);
            if(dn >= 3) high += surf;
        });

        document.getElementById('val-surf').innerText = (high/10000).toFixed(0);
        document.getElementById('val-ivm').innerText = (riskSum/total).toFixed(2) + "/4";

        initCharts(dist);
    }

    // 4. GRAPHIQUES (Code Blindé)
    function initCharts(dataArr) {
        const total = dataArr.reduce((a,b)=>a+b,0);
        
        // SECURITÉ : Si aucune donnée, on met des valeurs bidon pour afficher le graphique quand même
        let finalData = dataArr.map(d => ((d/total)*100).toFixed(1));
        if (total === 0) {
            console.warn("Pas de données ! Affichage démo.");
            finalData = [20, 20, 20, 20, 20]; // Données de test
        }

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.font.family = 'Outfit';

        // POLAR (Le graphique qui posait problème)
        const ctxPolar = document.getElementById('polarChart');
        if (ctxPolar) {
            new Chart(ctxPolar, {
                type: 'polarArea',
                data: {
                    labels: ['Nul', 'Faible', 'Moyen', 'Fort', 'Critique'],
                    datasets: [{
                        data: finalData,
                        backgroundColor: colors.map(c => c + 'BB'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Important !
                    scales: {
                        r: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { display: false, backdropColor: 'transparent' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // BAR CHART
        const ctxBar = document.getElementById('barChart');
        if (ctxBar) {
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Nul', 'Faible', 'Moyen', 'Fort', 'Critique'],
                    datasets: [{ data: finalData, backgroundColor: colors, borderRadius: 4 }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { color: '#334155' } }, y: { grid: { display: false } } }
                }
            });
        }
    }

    // 5. INTERACTION
    window.toggleLayer = function(l) {
        const btn = event.currentTarget;
        btn.classList.toggle('active');
        if(l === 'sat') {
            const o = map.getPaintProperty('sat', 'raster-opacity');
            map.setPaintProperty('sat', 'raster-opacity', o===1 ? 0 : 1);
        } else {
            const v = map.getLayoutProperty('com', 'visibility');
            map.setLayoutProperty('com', 'visibility', v==='visible'?'none':'visible');
            map.setPaintProperty('com', 'line-opacity', v==='visible'?0:0.6);
        }
    }
</script>

</body>
</html>